using System;
using System.Collections.Generic;
using System.Linq;
using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;

namespace Bricklayer.Core.Common.World
{
    /// <summary>
    /// A tile's block type (Ex: Dirt, Stone, etc)
    /// </summary>
    public class BlockType
    {
        /// <summary>
        /// List of all block types.
        /// </summary>
        public static List<BlockType> Blocks { get; }

        /// <summary>
        /// How players should collide with this tile. (Only used for foregrounds).
        /// </summary>
        public BlockCollision Collision { get; set; }

        /// <summary>
        /// The average color of the tile to appear on the minimap.
        /// </summary>
        public Color Color { get; set; }

        /// <summary>
        /// ID of this block used for loading and saving blocks.
        /// A list of IDs is generated by the server at startup, depending on what plugins are loaded and how many blocks they
        /// contain.
        /// </summary>
        public ushort ID { get; }

        /// <summary>
        /// Defines if this block is a background or foreground.
        /// </summary>
        public Layer Layer { get; private set; }

        /// <summary>
        /// Name of the block.
        /// </summary>
        public string Name { get; private set; }

        /// <summary>
        /// The texture of this block. (Null on serverside)
        /// </summary>
        public Texture2D Texture { get; set; }

        /// <summary>
        /// The function to draw this block.
        /// </summary>
        /// <remarks>
        /// Note: Using an Action instead of a method call or inlined code has no effect on performance :)
        /// </remarks>
        public Action<SpriteBatch, Tile, int, int> Draw { get; set; }

        /// <summary>
        /// Indicates whether or not this block has a texture and should be rendered.
        /// </summary>
        public bool IsRenderable { get; set; }

        /// <summary>
        /// The category of this block.
        /// </summary>
        /// <remarks>
        /// Used for grouping in the inventory.
        /// Blocks in a category must be placed in a subfolder in the Textures/blocks/ folder that corresponds with the name.
        /// </remarks>
        public BlockCategory Category { get; set; }

        /// <summary>
        /// Source rectangle for the face of a tile. (Not the 2.5d part)
        /// </summary>
        public static Rectangle SourceRect { get; private set; } = new Rectangle(0, 4, Tile.Width, Tile.Height);

        static BlockType()
        {
            Blocks = new List<BlockType>();
        }

        /// <summary>
        /// Creates a new instance a block type and adds it to the block list.
        /// </summary>
        /// <param name="name">Name of the block</param>
        /// <param name="layer">The layer(s) the tile can be placed on.</param>
        /// <param name="collision">The physics that the tile will interact with entities with.</param>
        /// <param name="category">Block category used for sorting in the inventory.</param>
        public BlockType(string name, Layer layer, BlockCollision collision = BlockCollision.Passable, BlockCategory category = null)
        {
            // TODO: ID will be calulcated by server, and the list will be rearranged after plugins are loaded
            // This way we can use an array or list instead of LINQ/for loop to find an id in `FromID`
            Name = name;
            Layer = layer;
            Collision = collision;
            Category = category;
            ID = (ushort)Blocks.Count();
            IsRenderable = true;

            Draw = (batch, tile, x, y) =>
            {
                batch.Draw(Texture, new Vector2(x * Tile.Width, y * Tile.Height));
            };

            Blocks.Add(this);
        }

        /// <summary>
        /// Finds a <c>BlockType</c> from it's ID
        /// </summary>
        public static BlockType FromID(ushort ID)
        {
            // ReSharper disable once ForCanBeConvertedToForeach
            // ReSharper disable once LoopCanBeConvertedToQuery
            // For loop for optimization as this is called for every tile access
            for (var i = 0; i < Blocks.Count; i++)
            {
                var x = Blocks[i];
                if (x.ID == ID) return x;
            }
            return null;
        }

        public override string ToString()
        {
            return Name;
        }
    }
}